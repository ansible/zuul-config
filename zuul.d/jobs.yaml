# Shared zuul config specific to the Ansible Project
# Contains definitions of trusted jobs
# Overrides jobs from:
#    https://github.com/ansible-network/ansible-zuul-jobs

# Changes to this job require a special procedure, because they can
# not be tested before landing, and if they are faulty, they will
# break all jobs, meaning subsequent corrections will not be able to
# land.  To make a change:
#
# 1) Ensure that base-minimal-test and its playbooks are identical to
#    base-minimal.
# 2) Make the change to base-minimal-test and/or its playbooks.
# 3) Merge the change from step 2.  No jobs normally use
#    base-minimal-test, so this is safe.
# 4) Propose a change to a job to reparent it to base-minimal-test.
#    Choose a job which will exercise whatever you are changing.  The
#    "unittests" job in zuul-jobs is a good choice.  Use [DNM] in the
#    commit subject so that people know not to merge the change.  Set
#    it to "Work in progress" so people don't review it.
# 5) Once test results arrive for the change in step 2, make a change
#    which copies the job and/or playbooks of base-minimal-test to
#    base-minimal. In the commit message, link to (without using
#    Depends-On:) the change from step 4 so reviewers can see the
#    test results.
# 6) Once the change in step 5 merges, abandon the change from step 4.

- job:
    name: base
    parent: null
    description: |
      The base-minimal job for Ansible's installation of Zuul.
    pre-run: playbooks/base/pre.yaml
    post-run:
      - playbooks/base/post.yaml
    roles:
      - zuul: sf-jobs
      - zuul: zuul/zuul-jobs
    extra-vars:
      zuul_use_fetch_output: true
    timeout: 1800
    attempts: 3
    secrets:
      - site_ansiblelogs
    nodeset:
      nodes:
        - name: container
          label: pod-fedora-31

# Software Factory management job
- semaphore:
    name: semaphore-config-update
    max: 1

- job:
    name: config-check
    parent: base
    final: true
    allowed-projects:
      - ansible/zuul-config
    description: Validate the config repo.
    run: playbooks/config/check.yaml
    post-run: playbooks/config/check-fetch-artifacts.yaml
    secrets:
      - service_user
    vars:
      zuul_log_url: "https://ansible.softwarefactory-project.io/logs"
      gateway_url: "https://ansible.softwarefactory-project.io"
      tenant_config: True
      master_sf_url: https://softwarefactory-project.io
    nodeset:
      nodes: []

- job:
    name: config-update
    parent: base
    final: true
    allowed-projects:
      - ansible/zuul-config
    description: Deploy config repo update.
    run: playbooks/config/update.yaml
    secrets:
      - site_install_server
      - site_tenant_update
    semaphore: semaphore-config-update
    nodeset:
      nodes: []

- job:
    name: config-linters
    run: playbooks/linters.yaml

- project:
    name: ansible/zuul-config
    check:
      jobs:
#        - config-linters
        - config-check
    gate:
      jobs:
#        - config-linters
        - config-check
    post:
      jobs:
        - config-update

- job:
    name: wait-for-changes-ahead
    parent: null
    timeout: 7200
    nodeset:
      nodes: []
    vars:
      zuul_web_url: "https://ansible.softwarefactory-project.io/zuul"
    description: |
      This job wait for the queue ahead to be empty.

      Responds to these variables:

      .. zuul:jobvar:: zuul_web_url

         The zuul web api url.

      .. zuul:jobvar:: wait_timeout
         :default: 120

         Wait timeout in minutes.

    run: playbooks/wait-for-changes-ahead.yaml

- job:
    name: build-ansible-collection
    description: |
      Build ansible collections and return artifacts to zuul
    pre-run: playbooks/build-ansible-collection/pre.yaml
    run: playbooks/build-ansible-collection/run.yaml
    post-run:
      - playbooks/build-ansible-collection/post.yaml
    required-projects:
      - github.com/ansible-network/releases
    nodeset:
      nodes:
        - name: controller
          label: ansible-fedora-35-1vcpu


# untrusted

- job:
    name: ansible-network-appliance-base
    pre-run: playbooks/ansible-network-appliance-base/pre.yaml
    post-run: playbooks/ansible-network-appliance-base/post.yaml
    files:
      - ^plugins/.*$
      - ^tests/integration/.*$

- job:
    name: ansible-test-cloud-integration-govcsim-python38
    nodeset:
      nodes:
        - name: controller
          label: ansible-fedora-35-1vcpu
    dependencies:
      - name: build-ansible-collection
    pre-run:
      - playbooks/ansible-test-base/pre.yaml
      - playbooks/ansible-cloud/govcsim-base/pre.yaml
      - playbooks/ansible-cloud/vcenter-integration-controller/pre.yaml
    run: playbooks/ansible-test-base/run.yaml
    post-run: playbooks/ansible-test-base/post.yaml
    required-projects:
      - name: github.com/ansible/ansible
#      - name: github.com/ansible/ansible-zuul-jobs
      - name: github.com/ansible-collections/community.vmware
    timeout: 3600
    vars:
      ansible_collections_repo: github.com/ansible-collections/community.vmware
      ansible_test_python: 3.8
      ansible_test_integration_targets: zuul/vmware/govcsim/
      ansible_test_command: integration
      ansible_test_split_in: 3
      ansible_test_collections: true
      ansible_test_environment:
        VMWARE_TEST_PLATFORM: static

- job:
    name: ansible-test-cloud-integration-govcsim-python38_1_of_3
    parent: ansible-test-cloud-integration-govcsim-python38
    vars:
      ansible_test_do_number: 1

- job:
    name: ansible-test-cloud-integration-govcsim-python38_2_of_3
    parent: ansible-test-cloud-integration-govcsim-python38
    vars:
      ansible_test_do_number: 2

- job:
    name: ansible-test-cloud-integration-govcsim-python38_3_of_3
    parent: ansible-test-cloud-integration-govcsim-python38
    vars:
      ansible_test_do_number: 3

### VMWARE-REST

- job:
    name: ansible-cloud-vcenter-appliance
    parent: ansible-network-appliance-base
    pre-run: playbooks/ansible-cloud/vcenter-appliance/pre.yaml
    run: playbooks/ansible-cloud/vcenter-appliance/run.yaml
#    required-projects:
#      - name: github.com/ansible/ansible-zuul-jobs
    # NOTE: we set ansible_network_os with some generic
    # value to pass the ansible-network playbooks
    host-vars:
      vcenter:
        ansible_network_os: vmware_rest
      esxi1:
        ansible_network_os: vmware_rest
    nodeset: vmware-vcsa-7.0.3-python36

- job:
    # NOTE: should be renamed to ansible-cloud-vmware-lab in
    # the future because it's more than just one appliance
    name: ansible-cloud-vmware-rest-appliance
    parent: ansible-network-appliance-base
    pre-run:
      - playbooks/ansible-cloud/vcenter-appliance/pre.yaml
    run: playbooks/ansible-cloud/vcenter-appliance/run.yaml
#    required-projects:
#      - name: github.com/ansible/ansible-zuul-jobs
    # NOTE: we set ansible_network_os with some generic
    # value to pass the ansible-network playbooks
    host-vars:
      vcenter:
        ansible_network_os: vmware_rest
      esxi1:
        ansible_network_os: vmware_rest
    nodeset: vmware-vcsa_1esxi-7.0.3-python36

- job:
    name: ansible-test-cloud-integration-vmware-rest-python38
    parent: ansible-test-cloud-integration-vmware-rest
    vars:
      ansible_test_python: 3.8
