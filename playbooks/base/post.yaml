---
- hosts: all:!appliance*
  tasks:
    - name: unregister the node
      command: subscription-manager unregister
      when: ansible_distribution == "RedHat"
      become: true
      ignore_errors: yes

    - block:
        - include_role: name=fetch-output
      when:
        - "ansible_connection != 'kubectl'"
        - ansible_user_dir is defined
    - block:
        - include_role: name=fetch-output-openshift
      when:
        - "ansible_connection == 'kubectl'"
        - ansible_user_dir is defined
    - import_role: name=merge-output-to-logs
      when: ansible_user_dir is defined

- hosts: localhost
  gather_facts: false
  tasks:
    - name: Run Zuul manifest role
      include_role:
        name: generate-zuul-manifest

    - name: Set zuul-log-path fact
      include_role:
        name: set-zuul-log-path-fact
      vars:
        zuul_log_path_shard_build: true

    - name: Build log upload targets and run failover (Swift only, to rule out failover config issues)
      ansible.builtin.block:
        - name: Set zuul_log_targets (Swift with random Rackspace region)
          ansible.builtin.set_fact:
            zuul_log_targets: "{{ swift_target }}"
          vars:
            swift_target:
              - target: swift
                args:
                  zuul_log_partition: true
                  zuul_log_container: ansible
                  zuul_log_cloud_config: "{{ item }}"
                  zuul_log_delete_after: 7776000
                  
        - name: Run upload-logs-failover role (S3 then Swift)
          no_log: true
          include_role:
            name: upload-logs-failover
          vars:
            zuul_log_targets: "{{ zuul_log_targets }}"