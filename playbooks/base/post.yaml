---
- hosts: all:!appliance*
  tasks:
    - name: unregister the node
      command: subscription-manager unregister
      when: ansible_distribution == "RedHat"
      become: true
      ignore_errors: yes

    - block:
        - include_role: name=fetch-output
      when:
        - "ansible_connection != 'kubectl'"
        - ansible_user_dir is defined
    - block:
        - include_role: name=fetch-output-openshift
      when:
        - "ansible_connection == 'kubectl'"
        - ansible_user_dir is defined
    - import_role: name=merge-output-to-logs
      when: ansible_user_dir is defined

- hosts: localhost
  gather_facts: false
  tasks:
    - name: Run Zuul manifest role
      include_role:
        name: generate-zuul-manifest

    - name: Set zuul-log-path fact
      include_role:
        name: set-zuul-log-path-fact
      vars:
        zuul_log_path_shard_build: true

    - name: Run upload-logs-s3 role
      no_log: true
      include_role:
        name: upload-logs-s3
      vars:
        zuul_log_partition: true
        zuul_log_bucket: zuul-logging
        zuul_log_aws_access_key: "{{ aws_s3_bucket_key.public_key }}"
        zuul_log_aws_secret_key: "{{ aws_s3_bucket_private_key.private_key }}"
